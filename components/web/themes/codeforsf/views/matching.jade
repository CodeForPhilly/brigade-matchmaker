/**
/* This section is the Wizard selector results and is under construction
/* For testing this is called from http://localhost5465/matching
/*
*/
script(src='https://code.jquery.com/jquery-3.1.1.min.js')


extends layout

block content
	body
	div.container-maxWidth970
		div.large-hero
			h3.large-hero--font-narrow You are matched! Explore the details of the project teams, and connect to the teams that you are interested in. When you connect, a message with your profile and email will be sent to the project team lead(s).


		h1.h1--more-margin.h1--icon-before.brigadeSF-font-fam  You searched for:
		div(id="matchingConfigs-list")


		h1.h1--more-margin.brigadeSF-font-fam  Your matching projects:
		div(id="projects-list")

		<br />
		div.text-center
			div.btn-group(role="group" aria-label="...")
				button(type="button" class="btn btn-warning") Back
				button(type="button" class="btn btn-info") Home
				button(type="button" class="btn btn-primary") Restart the Matching Hat wizard

		include partials/_mail_form

block script
	// NOTE: put the dot after script(). and the js is rendered only for client interpretation
	script().

		jQuery(document).ready(function () {

			jQuery.ajax({
				url: '/api/user/matches?skills=javascript,python&interests=housing&goals=developer,presenter'
			}).done(function (matchresults) {
				//console.log('Now have the usermatch Ajax call results: ', matchresults.projects);
				if (typeof matchresults.projects !== 'undefined' && matchresults.projects[0]) {
					var html = '<div class="row match-cfg-heading">';
					html+= '<section class="section__matchGoal col-sm-4 col-xs-push-0"><h3 class="config">Goals</h3></section>';
					html+= '<section class="section__matchSkill col-sm-4 col-xs-push-0"><h3 class="config">Skills</h3></section>';
					html+= '<section class="section__matchInterest col-sm-4 col-xs-push-0"><h3 class="config">Interests</h3></section>';
					//html+= '</div>';
					//jQuery('#matchingConfigs-list').append(html);
					//html = '<div class="row mitem">';
					html+= '<span class="row">'
					html+= '<section class="section__matchGoal col-sm-4 col-xs-push-0">';
						for (i = 0; i < matchresults.goals.length; i++ ) {
							html += '<span class="mitem">' + matchresults.goals[i] + '</span>';
						}
						html += '</section>';
						html+= '<section class="section__matchSkill col-sm-4 col-xs-push-0">';
						for (i = 0; i < matchresults.skills.length; i++ ) {
							html += '<span class="mitem">' + matchresults.skills[i] + '</span>';
						}
						html += '</section>';
						html+= '<section class="section__matchInterest col-sm-4 col-xs-push-0">';
						for (i = 0; i < matchresults.interests.length; i++ ) {
							html += '<span class="mitem">' + matchresults.interests[i] + '</span>';
						}
					html += '</span></section>';
					html+= '</div>';
					jQuery('#matchingConfigs-list').append(html);

					// Now, run through the user matching projects, and output details
					// in the project list style
					for (q = 0; q < matchresults.projects.length; q++) {

						//showProjListHeadings();
						listMatchingProjects(matchresults.projects[q]);
					}

				}
				}).fail(function (err) {
				console.error(err); return;
			});
		})	  //interest/skill/goal selections now output, next come the matching projects


		function listMatchingProjects(matchingProject) {

			jQuery.ajax({
				url: '/api/projects'
			}).done(function (results) {
				var proj_exists = 'false';
				if (typeof results.projects !== 'undefined' && results.projects[0]) {
					results.projects.forEach(function (proj, idx) {

						if(proj.name === matchingProject.id) { // this is a hit, add details and output
							showProjListHeadings()
							outputProjectInfo(proj);
							proj_exists = 'true';
						}
					})

					if (proj_exists === 'false') {
						showProjListHeadings()
						outputNotFoundInfo(matchingProject.id);

					}
				}
				console.log($('.message-team').text())
				$('.message-team').on('click', function(e) {
					console.log('The nodename clicked was ', event.target.nodeName)
					showContactForm(e);
					//This is now working and hides the button when clicked

				})

				$('#cancelform').on('click mouseover', function(e) {
					cancelContactForm(e);

				})



			}).fail(function (err) {
				console.error(err); return;
			})
		}

		function showContactForm(e) {
			console.log('This is from within the showContactForm fn');
			prefillContactForm();
			$( '.send-msg--hidden').removeClass('send-msg--hidden').addClass('send-msg--visible');

			//).removeClass('send-msg--hidden').addClass('send-msg--visible');
			//This is now working and hides the button when clicked

		}

		function cancelContactForm(e) {
			console.log('This is from within the cancelContactForm ' + e.type);
			$( '.send-msg' ).removeClass('send-msg--visible').addClass('send-msg--hidden');
		}

		function prefillContactForm() {
			document.getElementById("comment").placeholder = "Send a message and questions to the Team Leader using this email form. \n\n We will not reveal your email address (it will be anonymized), but you will receive a reply directly to the email you checked in with. \n\n Your goals, skills and interests as given to the matching wizard will be appended to your message automatically. \n\n <em>Go ahead and start a conversation about how you can help!</em>"
		}


		function outputNotFoundInfo(projNotFound) {
			var not_proj = {}
				not_proj.name = projNotFound,
				not_proj.description = 'Not Found';
				not_proj.matchingConfig = {};

			outputProjectInfo(not_proj);
		}

		function outputProjectInfo(proj) {
			var html = '';
			var html = '<div class="row projects-list__row--projects">';
			html+= '<section  class="projects-list__row--fixed-height col-sm-2 col-xs-push-0">';
			html+= '<button type="button" class="message-team mail-icon mail-icon__centered btn btn-primary btn-large" aria-label="Left Align"><span class="glyphicon glyphicon-envelope text-center" aria-hidden="true"></span></button></section>';

			html+= '<section class="col-sm-2 col-xs-push-0">';
			html+= '<span class="row text-center">' + 'Project Leader' + '</span></section>';
			html+= '<section class="col-sm-4 col-xs-push-0">';
			html+= '<span class="row text-center">' + proj.name + '</span></section>';

			html+= '<section class="col-sm-4 col-xs-push-0">';
			html+= '<span class="row">' + proj.description + ' This project needs a mission statement showing how the team will foster social progress.' + '</span></section></div>';

			var Configs = proj.matchingConfig;
			html+= '<div class="row projects-list__row--rolesskillsints">';  //Start next row for the same project - configs
			//
			//Print out the project needs/interest headings
			//
			html+= '<section class="project-list__row-interests-set col-sm-4 col-xs-push-0">';
			html+= '<span class="row projects-list__row--info text-center"><strong> ' + 'Seeking: ' + '</strong></span></section>';
			html+= '<section class="project-list__row-interests-set col-sm-4 col-xs-push-0">';
			html+= '<span class="row projects-list__row--info"><strong> ' + 'Skills Needed: ' + '</strong></span></section>';
			html+= '<section class="project-list__row-interests-set col-sm-4 col-xs-push-0">';
			html+= '<span class="row projects-list__row--info"><strong> ' + 'Our Areas of Focus: ' + '</strong></span></section>';
			html+= '</div>';

			var Configs = proj.matchingConfig;
			html+= '<div class="row projects-list__row--project-needs">';  //Start next row for the same project - configs
			Object.keys(Configs).forEach(key => {
				html+= '<section class="section__project-needs col-sm-4 col-xs-push-0">'  //start section
				for(k = 0; k < proj.matchingConfig[key].length; k++ ) {
					html+= '<div class="project-list__row-cfgs-badges project-list__row-' + key + '-badge">' + proj.matchingConfig[key][k] + '</div>';
				}
				html+= '</section>'; //close the section for this category of matching configs
			})
			html+= '</div>';
			html+= '<div "class=row row--separator"><br /></div>';
			jQuery('#projects-list').append(html);


		}

		function showProjListHeadings() {

		var html = '';
		var html = '<div class="row projects-list__row--projects projects-list--headings">';
			html+= '<section  class="projects-list__row--projects text-center col-sm-2 col-xs-push-0">';
			html+= '<span class="row projects-list--headings">Contact Team</span></section>';

			html+= '<section class="projects-list__row--projects col-sm-2 col-xs-push-0">';
			html+= '<span class="row text-center projects-list--headings">Team Leader</span></section>';
			html+= '<section class="projects-list__row--projects col-sm-4 col-xs-push-0">';
			html+= '<span class="row projects-list--headings">Project Name</span></section>';

			html+= '<section class="projects-list__row--projects col-sm-4 col-xs-push-0">';
			html+= '<span class="row projects-list--headings">Project Mission Statement</span></section></div>';
			html+= '<div> </div';

			jQuery('#projects-list').append(html);

			}

			$(document).ready(function(){
				$("form").submit(function(e){
					e.preventDefault();
				  $('#confirm_sent').css("visibility", "visible" );
					$('#comment').val('').blur(); //erase the input and replace placeholder
					$( "div.send-msg" ).removeClass('send-msg--visible').addClass('send-msg--hidden');
					setTimeout(function() {
						$('#confirm_sent').css("visibility", "hidden" );
					}, 4000);

				})
			});
